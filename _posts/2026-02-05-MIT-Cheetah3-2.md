---
title: "MIT Cheetah 3 Locomotion in Simulation <small><i>– Part 1. Leg Contact Detection</i></small>"
tagline: "A step-by-step implementation in MuJoCo (Go2)"
excerpt: "Probabilistic Contact Detection based on Contact Model Fusion"
categories:
  - fun
tags:
  - locomotion
  - control
author_profile: false
header:
  image: /assets/images/unsplash-image-4.jpg
  teaser: /assets/images/unsplash-image-4.jpg
---

<p style="text-align: left; color: #7d8590; font-size: 1.0rem; margin-top: -1.1.1rem; margin-bottom: 2rem; font-style: italic;">
Contact Model Fusion for Event-Based Locomotion in Unstructured Terrains
</p>

## 목표
![Traversing Rough Terrain with Event-Based Gait Switching](/assets/images/cheetah.png)
<br><br>
This post implements the contact probability estimator proposed in Contact Model Fusion for Event-Based Locomotion in Unstructured Terrains, as a prerequisite for reproducing the MIT Cheetah 3 control architecture.
<br><br><br>
Cheetah3 내부는 세가지의 큰 시스템이 있고 서로 상호작용하면서 돌아간다는 것을 전 포스팅에서 짧게 브리핑했다. 1.상태 추정기, 2. 상위레벨 스케줄러, 3. 제어기. 제어기를 만드려면 명령이 있어야 하고 그 명령은 스케줄러에서 만들어진다. 스케줄러는 상태에 따라 어떤 명령을 내려야하는지 정하는 두뇌 역할을 하는데 그러기 위해 상태값에 대한 추정이 선행되어야 한다. Cheetah3 의 핵심 기술 중 하나는 내부 센서데이터의 조합만으로 로봇이 발을 디디고 있는지 아닌지를 파악하는 것이므로 Leg Contact Detection을 제일 먼저 구현해보기로 결정.  


> Since the robot does not use any external environment sensors, a contact detection algorithm probabilistically fuses encoder measurements, estimated force, and expected gait phase to estimate the likelihood that each leg is in contact with an object [11].


여기서 인용된 [11] 논문인 *Contact Model Fusion for Event-Based Locomotion in Unstructured Terrains* 를 구현해보자.
<br><br><br>

## 구조
이 논문은 비정형 지형을 이동하는 사족보행로봇(Cheetah 3)을 위해, 외부 센서 없이 자기수용(proprioceptive) 센서 데이터만으로 작동하는 강인한 지면 접촉 감지 알고리즘을 제안한다. 불규칙한 지면에서 발생하는 조기·지연 접촉에 대응하여 보행 안정성을 확보하고자, 시간 기반 스케줄러와 접촉 이벤트 기반 전환 시스템을 결합했다. 구조는 아래처럼 구성된다:
1. 지지반력을 외란토크으로 두고 외란관측기를 설계하여 각 발에 대한 지지반력을 계산
2. 계산된 지지반력과 발높이를 측정모델, 주기적인 보행패턴을 시스템모델로 칼만필터를 설계하여 발 접촉 확률 계산
3. Finite State Machine을 이용한 예기치 못한 접촉에 대응하는 전환시스템 설계<br><br>


### 1. Momentum-based disturbance observer for discrete-time implementation

- 로봇의 기본 Equation of Motion 은 아래와 같다. <br><br>

$$
\mathbf{M} \ddot{\mathbf{q}}+\mathbf{C} \dot{\mathbf{q}}+\mathbf{g}=\mathbf{S}^{\top} \boldsymbol{\tau}+\sum_i \mathbf{J}_i^{\top} \mathbf{f}_i^e
$$

**where:**

$$
\begin{array}{lcl}
\mathbf{q} \in \mathbb{R}^{n_d} &  & \text{Joint angles (Generalized coordinates)} \\
n_d &  & \text{Number of degrees of freedom (DoF)} \\
\mathbf{M} \in \mathbb{R}^{n_d \times n_d} &  & \text{Symmetric positive-definite mass matrix} \\
\mathbf{C} \dot{\mathbf{q}} \in \mathbb{R}^{n_d} &  & \text{Generalized Coriolis and centrifugal force vector} \\
\mathbf{g} \in \mathbb{R}^{n_d} &  & \text{Generalized gravity force vector} \\
\boldsymbol{\tau} \in \mathbb{R}^{n_j} &  & \text{Vector of actuated joint torques} \\
\mathbf{S} \in \mathbb{R}^{n_j \times n_d} &  & \text{Actuated joint selector matrix (}n_j\text{: number of actuated joints)} \\
\mathbf{J}_i \in \mathbb{R}^{3 \times n_d} &  & \text{Analytic Jacobian matrix for the }i\text{-th contact point} \\
\mathbf{f}_i^e \in \mathbb{R}^3 &  & \text{External force vector acting on the }i\text{-th contact point}
\end{array}
$$

---

<br><br>
- 외란 설명, 식 도출
<br><br>
- 이산식 도출 <br><br><br>

### 2. PROBABILISTIC CONTACT MODEL FUSION
- 로봇발 높이 계산
로봇다리는 링크 2개(허벅지, 종아리), 관절 3개로 이루어져있다. 여기서 바로 발 위치를 3D 공간에서 계산하지 않고, 로봇 측면(side view)에서의 2링크 시스템 기구학 문제로 단순화 하면 매우 간단해진다. 허벅지와 종아리가 움직이는 2차원 단면에서 링크의 끝단(발)위치를 계산한다. 이 계산한 결과를 링크 한개의 끝단 위치로 가정하면 1dof 로봇팔 문제로 볼수 있게 되고, 외전(Abduction) 각도만큼 회전 변환을 적용하면 body frame내의 3D 발 위치를 계산할수 있다. <br><br>

{% include /diagram/robot_link.html %} <br>

- 사용해야하는 발위치값은 world coordinate system으로 변환하기 위해 아래처럼 좌표변환을 진행한다.<br><br>

$$
{ }^W \mathbf{p}_{\text {foot }}={ }^W \mathbf{R}_B(\mathbf{q}) \cdot{ }^B \mathbf{p}_{\text {foot }}+{ }^W \mathbf{p}_{\text {base }}
$$

**where:**

$$
\begin{array}{lcl}
{}^W\mathbf{p}_{foot} &  & \text{월드 좌표계(World Frame) 기준의 발 위치 벡터 (}3 \times 1\text{)} \\
{}^B\mathbf{p}_{foot} &  & \text{로봇 몸체 좌표계(Body Frame) 기준의 발 위치 벡터} \\
{}^W\mathbf{R}_B(\mathbf{q}) &  & \text{쿼터니언 }\mathbf{q}\text{로부터 변환된 회전 행렬 (Body to World Rotation Matrix)} \\
{}^W\mathbf{p}_{base} &  & \text{월드 좌표계 기준의 로봇 기저(Base) 위치 벡터}
\end{array}
$$

{% include /diagram/robot_link2.html %}

발 위치값에서 z축 요소값만 사용할 예정.

- 로봇 지지반력 계산
- 칼만 적용

### 3. EVENT-BASED GAIT SWITCHING


###

